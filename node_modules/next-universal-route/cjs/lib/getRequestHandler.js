"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getRequestHandler = void 0;
var request_ip_1 = require("request-ip");
var Routes_1 = require("./Routes");
var getRequestHandler = function (app, routes, options) {
    var nextHandler = app.getRequestHandler();
    var router = new Routes_1.Routes(routes);
    return function (req, res) {
        var route = router.getRoute(req.url);
        req.clientIp = request_ip_1.getClientIp(req);
        if (route) {
            var customHandler = route.getCustomHandler(app);
            var page = route.page;
            if (options && options.subdomain) {
                var isSubdomain = req.subdomains.indexOf(options.subdomain) > -1;
                if (isSubdomain && route.hasSubdomain(options.subdomain)) {
                    page = "/" + options.subdomain + route.page;
                }
            }
            if (customHandler) {
                customHandler(req, res, page, route.query);
            }
            else {
                app.render(req, res, page, route.query);
            }
        }
        else {
            nextHandler(req, res, req.url);
        }
    };
};
exports.getRequestHandler = getRequestHandler;
